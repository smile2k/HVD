
# 1. Khi nào cần dùng Unsafe
Bạn có thể cần sử dụng mã không an toàn khi:
- Cần thực hiện các thao tác hiệu suất cao mà không thể thực hiện được trong mã an toàn.
- Cần truy cập trực tiếp vào bộ nhớ hoặc các cấu trúc dữ liệu cụ thể trong bộ nhớ.
- Giao tiếp với các API hoặc thư viện không được quản lý (unmanaged code), chẳng hạn như gọi các hàm trong thư viện C/C++.
# 2. Cách sử dụng Unsafe trong C# 
Để sử dụng mã không an toàn trong C#, bạn phải làm hai việc:
1. **Khai báo mã `unsafe`**: Sử dụng từ khóa `unsafe` để khai báo một khối mã, phương thức hoặc lớp không an toàn.
2. **Bật cho phép mã không an toàn**: Đảm bảo rằng dự án của bạn được cấu hình để cho phép mã không an toàn. Trong Visual Studio, bạn có thể làm điều này bằng cách vào **Project Properties** > **Build** > **Allow unsafe code**.
## Example
```CSharp
using System;
class Program
{
    static void Main()
    {
        int number = 10;
        
        // Sử dụng khối mã unsafe
        unsafe
        {
            int* p = &number;  // Lấy địa chỉ của biến number
            Console.WriteLine("Value of number: " + number);
            Console.WriteLine("Address of number: " + (int)p);

            *p = 20;  // Thay đổi giá trị của biến number thông qua con trỏ
            Console.WriteLine("New value of number: " + number);
        }
    }
}
```

# 3. Lưu ý về Unsafe trong C#
- **Hiệu suất và an toàn**: Mặc dù mã không an toàn có thể cung cấp hiệu suất cao hơn và truy cập trực tiếp vào bộ nhớ, nó cũng có thể dẫn đến các lỗi bộ nhớ như tràn bộ đệm, lỗi truy cập bộ nhớ và các lỗ hổng bảo mật. Do đó, bạn nên sử dụng mã không an toàn một cách cẩn thận và chỉ khi thực sự cần thiết.
- **Garbage Collection**: Khi sử dụng mã không an toàn, bạn phải đặc biệt chú ý đến Garbage Collection của .NET, vì con trỏ có thể trở nên không hợp lệ nếu đối tượng mà nó trỏ tới bị di chuyển hoặc thu hồi bởi GC. Việc sử dụng từ khóa `fixed` giúp ngăn chặn đối tượng bị di chuyển bởi GC.
- **Khả năng tương thích**: Mã không an toàn không tương thích với tất cả các môi trường chạy .NET. Ví dụ, nó có thể không hoạt động trong một số môi trường hạn chế về bảo mật như các ứng dụng web chạy trong sandbox.

# 4. Ví dụ

```CSharp
using System;

class Program
{
    static unsafe void Main()
    {
        int a = 10;
        string b = "h";
        int c = 100;

        int* x = &a;
        string* y = &b;
        int* z = &c;

        Console.WriteLine("x= {0}, y= {1}, z= {2}", (int)x, (int)y , (int)z);
    }
}

print

```

Kết quả:
```cmd
x= 427615580, y= 427615568, z= 427615564
x= 17840559488, y= 17840559464, 17840559460
```

```Assembly
64 00 00 00 | 90 ba f3 4a 87 02 00 00 00 00 00 00 | 0a 00 00 00
	100                  "h"                            10
&a            &b                                    &c
                   2780101327516
```

+ &a , &c : chứa địa vùng nhớ  chứa giá trị của a và c trên stack
+ &b: là địa chỉ của biến tham chiếu `b` trong `stack` , còn giá trị của biến tham chiếu được lưu trong `heap`

